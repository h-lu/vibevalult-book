---
title: "8.4 - PostgreSQL 实战指南：连接与操作"
---

> "工欲善其事，必先利其器。" - 孔子

## 本节任务：掌握数据库操作工具

在上一节，我们完成了从文件系统到PostgreSQL数据库的迁移。现在，我们需要掌握如何直接与数据库交互，以便在开发过程中验证数据、调试问题，以及执行一些必要的数据库操作。

本节将为你提供完整的PostgreSQL使用指南，特别是针对课程提供的共享数据库服务器的连接和操作说明。

## 连接信息

课程提供了一个共享的PostgreSQL服务器，每个学生都有自己独立的数据库账户：

- **服务器地址**: `49.234.193.192`
- **端口**: `5432`
- **用户名**: `st` + 你的学号（例如：学号 `12345678`，用户名为 `st12345678`）
- **数据库名**: `st` + 你的学号（与用户名相同）
- **初始密码**: 学号后6位（例如：学号 `12345678`，密码为 `345678`）

> **重要提示**: 如果你使用的是课程提供的共享数据库服务器，请使用上述连接信息。如果你在本地安装了PostgreSQL，请使用本地配置（通常是 `localhost:5432`）。

## 安装 psql 客户端工具

`psql` 是PostgreSQL官方提供的命令行客户端工具，是与数据库交互最直接、最强大的方式。如果你还没有安装 `psql`，请根据你的操作系统选择以下安装方法。

### Windows 11 安装方法

在 Windows 11 上，有几种简单的方法可以安装 `psql` 客户端工具（仅安装客户端，不安装数据库服务器）：

#### 方法一：使用官方安装程序（推荐）

1. **下载安装程序**：
   - 访问 PostgreSQL 官方下载页面：https://www.postgresql.org/download/windows/
   - 点击 "Download the installer"，选择适合你系统的版本（通常选择最新的稳定版）

2. **运行安装程序**：
   - 双击下载的安装文件（如 `postgresql-XX.X-windows-x64.exe`）
   - 在安装向导的 **"选择组件"** 步骤中：
     - ✅ **勾选** "Command Line Tools"（命令行工具）
     - ❌ **取消勾选** "PostgreSQL Server"（数据库服务器）
     - ❌ **取消勾选** "pgAdmin 4"（图形化管理工具）
     - ❌ **取消勾选** 其他不需要的组件
   - 按照提示完成安装

3. **验证安装**：
   - 打开命令提示符（Win + R，输入 `cmd`，回车）或 PowerShell
   - 输入以下命令检查 `psql` 是否安装成功：
   ```bash
   psql --version
   ```
   - 如果显示版本信息（如 `psql (PostgreSQL) 16.0`），说明安装成功

> **注意**: 安装程序会自动将 `psql` 添加到系统 PATH 环境变量中。如果安装后无法在命令行中使用 `psql`，可能需要重启终端或手动添加路径到环境变量（通常路径为 `C:\Program Files\PostgreSQL\<版本号>\bin`）。

#### 方法二：使用 Scoop 包管理器（最简单，推荐）

**Scoop** 是一个轻量级的 Windows 包管理器，非常适合安装命令行工具。使用 Scoop 安装 `psql` 是最简单的方法：

1. **安装 Scoop**（如果还没有安装）：
   ```powershell
   # 在 PowerShell 中执行（不需要管理员权限）
   Set-ExecutionPolicy RemoteSigned -Scope CurrentUser
   iwr -useb get.scoop.sh | iex
   ```

2. **添加 Scoop 的 "extras" 仓库**：
   ```powershell
   scoop bucket add extras
   ```

3. **安装 psql**：
   ```powershell
   scoop install psql
   ```

4. **验证安装**：
   ```powershell
   psql --version
   ```

> **优势**: Scoop 会自动配置环境变量，安装过程简单，且不需要管理员权限。这是 Windows 上安装命令行工具最推荐的方式。

#### 方法三：使用其他包管理器

如果你已经安装了其他包管理器，也可以使用：

**使用 winget**（Windows 11 自带，但命令较复杂）：
```powershell
# 注意：winget 安装 PostgreSQL 通常会安装完整版本，包括服务器
# 建议使用方法一或方法二（Scoop）
winget install PostgreSQL.PostgreSQL
```

**使用 Chocolatey**（需要先安装 Chocolatey）：
```powershell
# 在 PowerShell 中执行（需要管理员权限）
choco install postgresql --params '/Password:"" /NoPath'
```

> **提示**: 使用包管理器安装时，通常会自动配置环境变量。如果无法使用，请参考方法一中的环境变量配置说明。

#### 方法四：使用免安装绿色版

如果你不想在系统中安装任何东西，可以下载免安装的 PostgreSQL 绿色版：

1. 从第三方资源下载 PostgreSQL 绿色版（仅包含客户端工具）
2. 解压到任意目录（如 `C:\tools\postgresql-client`）
3. 将该目录下的 `bin` 文件夹添加到系统 PATH 环境变量中
4. 重启终端后即可使用 `psql` 命令

> **注意**: 使用绿色版时，请确保下载来源可靠，并注意版本兼容性。

### macOS 安装方法

如果你使用的是 macOS，可以使用 Homebrew：

```bash
# 安装 PostgreSQL 客户端工具（不安装服务器）
brew install libpq

# 将工具添加到 PATH（如果使用 zsh）
echo 'export PATH="/opt/homebrew/opt/libpq/bin:$PATH"' >> ~/.zshrc
source ~/.zshrc

# 验证安装
psql --version
```

### Linux 安装方法

如果你使用的是 Linux，可以使用系统包管理器：

**Ubuntu/Debian**:
```bash
sudo apt-get update
sudo apt-get install postgresql-client
```

**CentOS/RHEL**:
```bash
sudo yum install postgresql
```

**Fedora**:
```bash
sudo dnf install postgresql
```

## 首次连接：使用 psql 命令行工具

安装完成后，你就可以使用 `psql` 连接到数据库了。

### 基本连接命令

```bash
# 基本连接命令（会提示输入密码）
psql -h 49.234.193.192 -U st你的学号 -d st你的学号

# 示例：学号为 12345678
psql -h 49.234.193.192 -U st12345678 -d st12345678
```

### 使用连接字符串

你也可以使用完整的连接字符串来连接：

```bash
psql "postgresql://st你的学号:密码@49.234.193.192:5432/st你的学号"
```

### 连接成功后的提示

连接成功后，你会看到类似以下的提示符：

```
st12345678=>
```

这表示你已经成功连接到数据库，可以开始执行SQL命令了。

## 修改密码（强烈推荐）

首次登录后，强烈建议立即修改你的数据库密码，以提高安全性：

```sql
-- 在 psql 中执行
ALTER USER st你的学号 WITH PASSWORD '你的新密码';
```

> **安全建议**: 
>
> - 密码应包含字母、数字，长度至少8位
> - 不要使用过于简单的密码（如 `12345678`）
> - 修改密码后，记得更新你的 `application.properties` 文件中的密码配置

## 常用 SQL 操作

### 查看数据库信息

```sql
-- 查看当前用户
SELECT current_user;

-- 查看当前数据库
SELECT current_database();

-- 查看数据库版本
SELECT version();

-- 查看所有表（psql 快捷命令）
\dt

-- 查看表结构（psql 快捷命令）
\d 表名
```

### 创建表

```sql
-- 创建表示例（仅用于学习，实际项目中由 JPA/Hibernate 自动管理）
CREATE TABLE students (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    age INTEGER,
    email VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 插入数据

```sql
INSERT INTO students (name, age, email) VALUES
    ('张三', 20, 'zhangsan@example.com'),
    ('李四', 21, 'lisi@example.com');
```

### 查询数据

```sql
-- 查询所有数据
SELECT * FROM students;

-- 条件查询
SELECT * FROM students WHERE age > 20;

-- 排序
SELECT * FROM students ORDER BY age DESC;

-- 限制结果数量
SELECT * FROM students LIMIT 10;
```

### 更新数据

```sql
UPDATE students 
SET email = 'newemail@example.com' 
WHERE name = '张三';
```

### 删除数据

```sql
-- 删除特定记录
DELETE FROM students WHERE id = 1;

-- 清空表（谨慎使用！）
TRUNCATE TABLE students;
```

### 删除表

```sql
-- 删除表（谨慎使用！）
DROP TABLE students;
```

## psql 常用快捷命令

`psql` 提供了一系列以反斜杠（`\`）开头的快捷命令，这些命令不是SQL语句，而是 `psql` 特有的命令：

### 连接相关

```bash
# 连接到另一个数据库
\c 数据库名

# 断开连接并退出
\q

# 显示当前连接信息
\conninfo
```

### 信息查询

```sql
-- 列出所有数据库
\l

-- 列出当前数据库的所有表
\dt

-- 列出所有用户
\du

-- 显示表结构
\d 表名

-- 显示所有索引
\di

-- 显示所有视图
\dv
```

### 执行 SQL 文件

```bash
# 在 psql 中执行 SQL 文件
\i /path/to/script.sql

# 或在命令行直接执行 SQL 文件
psql -h 49.234.193.192 -U st你的学号 -d st你的学号 -f script.sql
```

## 在 Spring Boot 中配置数据库连接

当你使用课程提供的共享数据库服务器时，需要在 `application.properties` 中配置连接信息：

```properties
# In: chapter-code/ch08/app/src/main/resources/application.properties

# 数据库连接配置
spring.datasource.url=jdbc:postgresql://49.234.193.192:5432/st你的学号
spring.datasource.username=st你的学号
spring.datasource.password=你的密码  # <--- 请替换为你的实际密码

# JPA & Hibernate 配置
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true
```

> **注意**: 请将上述配置中的 `st你的学号` 和 `你的密码` 替换为你的实际学号和密码。

## 权限说明

在课程提供的共享数据库服务器上，你的账户具有以下权限：

- ✅ **完全管理自己的数据库**: 你可以创建表、插入数据、更新数据、删除数据等
- ✅ **修改自己的密码**: 你可以随时修改自己的账户密码
- ❌ **不能创建其他数据库**: 你只能使用为你分配的数据库
- ❌ **不能访问其他学生的数据库**: 这是正常的安全限制
- ❌ **不能删除其他学生的数据**: 你只能操作自己的数据

## 数据备份

定期备份你的数据是一个好习惯，特别是在进行重要实验之前：

```bash
# 使用 pg_dump 备份数据库
pg_dump -h 49.234.193.192 -U st你的学号 -d st你的学号 > backup.sql

# 恢复数据库
psql -h 49.234.193.192 -U st你的学号 -d st你的学号 < backup.sql
```

## 常见问题排查

### 1. 连接失败

**问题**: `psql: error: connection to server at "49.234.193.192", port 5432 failed`

**可能原因和解决方案**:

- 检查网络连接是否正常
- 确认服务器地址和端口正确（`49.234.193.192:5432`）
- 检查防火墙设置，确保允许访问该端口
- 如果使用VPN，确保VPN连接正常

### 2. 认证失败

**问题**: `password authentication failed for user`

**可能原因和解决方案**:

- 确认用户名格式正确（`st` + 学号，例如 `st12345678`）
- 确认密码正确（初始密码为学号后6位）
- 如果已修改密码，请使用新密码
- 如果忘记密码，联系课程管理员重置

### 3. 数据库不存在

**问题**: `database "xxx" does not exist`

**可能原因和解决方案**:

- 确认数据库名与用户名相同（`st` + 学号）
- 联系课程管理员检查账户是否已创建
- 确认你使用的是正确的数据库名

### 4. 权限不足

**问题**: `permission denied`

**可能原因和解决方案**:

- 确认你正在操作自己的数据库（数据库名应为 `st你的学号`）
- 不能访问其他学生的数据库，这是正常的安全限制
- 如果确实需要访问其他数据库，请联系管理员

### 5. Spring Boot 应用无法连接数据库

**问题**: 应用启动时报错，提示无法连接到数据库

**可能原因和解决方案**:

- 检查 `application.properties` 中的连接配置是否正确
- 确认用户名、密码、数据库名都已正确填写
- 确认服务器地址和端口正确
- 检查网络连接
- 查看应用日志中的详细错误信息

## Vibe Check (动手与思考)

### 实践任务

1. **首次连接**: 使用 `psql` 连接到课程提供的数据库服务器，验证连接是否成功。

2. **修改密码**: 首次登录后，立即修改你的数据库密码，并更新 `application.properties` 中的配置。

3. **探索数据库**: 使用 `\dt` 命令查看你的数据库中有哪些表。如果已经运行过第八章的代码，你应该能看到 `playlists` 和 `songs` 表。

4. **查看表结构**: 使用 `\d playlists` 和 `\d songs` 查看这两个表的结构，理解 JPA 是如何将 Java 实体映射到数据库表的。

5. **查询数据**: 使用 SQL 查询语句查看 `playlists` 和 `songs` 表中的数据，验证你的应用是否正确地将数据保存到了数据库。

### 思考问题

- **为什么需要修改初始密码？** 除了安全性考虑，还有什么其他原因？
- **`\dt` 和 `SELECT * FROM information_schema.tables` 有什么区别？** 它们都能查看表，但实现方式不同。请思考 `psql` 快捷命令的优势。
- **如果多个学生同时连接到同一个数据库服务器，会不会相互影响？** 为什么每个学生都有独立的数据库？

### AI 协同

"请解释一下 PostgreSQL 的 `SERIAL` 数据类型和 `IDENTITY` 列的区别。在 JPA 中，我们使用了 `@GeneratedValue(strategy = GenerationType.IDENTITY)`，这与 PostgreSQL 的 `SERIAL` 类型有什么关系？"

## 学习资源

- PostgreSQL 官方文档: https://www.postgresql.org/docs/
- PostgreSQL 官方教程: https://www.postgresql.org/docs/current/tutorial.html
- SQL 基础教程: https://www.w3schools.com/sql/
- psql 命令参考: https://www.postgresql.org/docs/current/app-psql.html

---

**掌握了数据库操作工具，你就能更好地理解ORM框架在幕后做了什么，也能在开发过程中更高效地调试和验证数据。** 🎓

