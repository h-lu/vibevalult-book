# 10.4 è§„çŸ©ï¼šåŸºäºæ‰€æœ‰æƒçš„æˆæƒæ§åˆ¶

> "èƒ½è¿›é—¨ï¼Œä¸ä»£è¡¨èƒ½ä¹±åŠ¨ã€‚" â€”â€” æˆæƒçš„æœ¬è´¨

## æœ¬èŠ‚å±æœºï¼šè®¤è¯â‰ æˆæƒ

åœ¨ä¸Šä¸€èŠ‚ï¼Œæˆ‘ä»¬å®Œæˆäº†å®Œæ•´çš„è®¤è¯ï¼ˆAuthenticationï¼‰ä½“ç³»ã€‚ç°åœ¨ï¼Œä»»ä½•æŒæœ‰æœ‰æ•ˆJWT Tokençš„ç”¨æˆ·éƒ½èƒ½è®¿é—®å—ä¿æŠ¤çš„APIã€‚

ä½†è¿™é‡Œéšè—ç€ä¸€ä¸ªä¸¥é‡çš„å®‰å…¨éšæ‚£ï¼š

**åœºæ™¯é‡ç°**ï¼š
1.  ç”¨æˆ·Aï¼ˆvibecoderï¼‰ç™»å½•ï¼Œåˆ›å»ºäº†ä¸€ä¸ªæ­Œå•"My Precious Playlist"ã€‚
2.  ç”¨æˆ·Bï¼ˆeviluserï¼‰ä¹Ÿç™»å½•äº†ï¼Œæ‹¿åˆ°äº†è‡ªå·±çš„JWT Tokenã€‚
3.  ç”¨æˆ·Bå‘é€è¯·æ±‚ï¼š`DELETE /api/playlists/my-precious-playlist`ï¼Œæºå¸¦ä»–è‡ªå·±çš„Tokenã€‚
4.  å› ä¸ºBçš„Tokenæ˜¯æœ‰æ•ˆçš„ï¼Œç³»ç»Ÿè®¤ä¸ºä»–"å·²è®¤è¯"ï¼Œç›´æ¥æ‰§è¡Œåˆ é™¤ã€‚
5.  Açš„æ­Œå•è¢«Båˆ é™¤äº†ã€‚

**é—®é¢˜çš„æœ¬è´¨**ï¼šæˆ‘ä»¬å®ç°äº†è®¤è¯ä½†æ²¡æœ‰æˆæƒã€‚

*   **è®¤è¯ï¼ˆAuthenticationï¼‰**ï¼šè¯æ˜"ä½ æ˜¯è°"ï¼ˆWho are you?ï¼‰
*   **æˆæƒï¼ˆAuthorizationï¼‰**ï¼šè¯æ˜"ä½ èƒ½åšä»€ä¹ˆ"ï¼ˆWhat can you do?ï¼‰

æˆ‘ä»¬çš„ç³»ç»Ÿç›®å‰çŠ¶æ€ï¼šçŸ¥é“ç”¨æˆ·æ˜¯è°ï¼Œä½†ä¸æ£€æŸ¥ä»–æ˜¯å¦æœ‰æƒæ‰§è¡Œæ“ä½œã€‚è¿™å°±åƒå…¬å¸ä¿å®‰çœ‹äº†ä½ çš„å·¥ç‰Œæ”¾ä½ è¿›é—¨ï¼Œä½†ä¸æ£€æŸ¥ä½ æ˜¯å¦æœ‰æƒè¿›å…¥è´¢åŠ¡å®¤ã€‚

## æœ¬èŠ‚é¡¿æ‚Ÿï¼šä¸šåŠ¡è§„åˆ™é©±åŠ¨çš„æˆæƒ

å¯¹äºVibeVaultåº”ç”¨ï¼Œæ ¸å¿ƒä¸šåŠ¡è§„åˆ™å¾ˆç®€å•ï¼š

> **ç”¨æˆ·åªèƒ½ä¿®æ”¹æˆ–åˆ é™¤ä»–è‡ªå·±åˆ›å»ºçš„æ­Œå•ã€‚**

è¿™æ˜¯ä¸€ç§**åŸºäºèµ„æºæ‰€æœ‰æƒ**çš„æˆæƒæ¨¡å¼ã€‚æˆ‘ä»¬éœ€è¦ï¼š

1.  **å»ºç«‹å…³è”**ï¼š`Playlist`å®ä½“éœ€è¦è®°å½•"è°æ˜¯ä¸»äºº"ï¼ˆownerï¼‰ã€‚
2.  **åœ¨Controllerå±‚æ£€æŸ¥**ï¼šåœ¨åˆ é™¤/ä¿®æ”¹æ“ä½œå‰ï¼ŒéªŒè¯`currentUser == playlist.owner`ã€‚
3.  **ç”¨å£°æ˜å¼æ³¨è§£**ï¼šä½¿ç”¨Spring Securityçš„`@PreAuthorize`ï¼Œè®©æˆæƒé€»è¾‘æ¸…æ™°å¯è¯»ã€‚

---

## ç¬¬ä¸€æ­¥ï¼šé‡æ„Playlistå®ä½“ï¼Œæ·»åŠ æ‰€æœ‰æƒå…³è”

ä¿®æ”¹`Playlist`å®ä½“ï¼Œæ·»åŠ `@ManyToOne`å…³è”åˆ°`User`ã€‚

::: {.callout-tip}
## ğŸ¤– AI Prompt
"ä¿®æ”¹ `Playlist` å®ä½“ï¼š
1. æ·»åŠ  `@ManyToOne` å…³è”åˆ° `User`ï¼Œå­—æ®µåä¸º `owner`ã€‚
2. æ›´æ–°æ„é€ å‡½æ•°ï¼Œè¦æ±‚åˆ›å»ºæ­Œå•æ—¶å¿…é¡»ä¼ å…¥ `owner`ã€‚"
:::

### ä»£ç è¦ç‚¹

*   `@ManyToOne`ï¼šå¤šä¸ªæ­Œå•å¯ä»¥å±äºä¸€ä¸ªç”¨æˆ·ã€‚
*   `FetchType.LAZY`ï¼šå»¶è¿ŸåŠ è½½ownerä¿¡æ¯ï¼ˆåªæœ‰åœ¨å®é™…è®¿é—®`playlist.getOwner()`æ—¶æ‰æŸ¥è¯¢æ•°æ®åº“ï¼‰ã€‚
*   `@JoinColumn(name = "owner_id")`ï¼šæ•°æ®åº“ä¸­ä¼šåˆ›å»º`owner_id`å¤–é”®åˆ—ã€‚

### æ•°æ®åº“è¿ç§»æç¤º

è¿™ä¸ªä¿®æ”¹ä¼šå¯¼è‡´æ•°æ®åº“è¡¨ç»“æ„å˜åŒ–ã€‚å¦‚æœä½ ä½¿ç”¨Spring Bootçš„è‡ªåŠ¨DDLï¼ˆ`spring.jpa.hibernate.ddl-auto=update`ï¼‰ï¼Œé‡å¯åº”ç”¨åHibernateä¼šè‡ªåŠ¨æ·»åŠ `owner_id`åˆ—ã€‚

**ä½†æ³¨æ„**ï¼šç°æœ‰çš„æ­Œå•æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰çš„`owner_id`ä¼šæ˜¯NULLï¼Œå¯¼è‡´è¿å`nullable = false`çº¦æŸã€‚

**ä¸¤ç§å¤„ç†æ–¹å¼**ï¼š
1.  **æ¸…ç©ºæ•°æ®é‡æ–°å¼€å§‹**ï¼ˆå¼€å‘é˜¶æ®µæ¨èï¼‰ï¼šåˆ é™¤`data`ç›®å½•ä¸‹çš„æ‰€æœ‰`.csv`æ–‡ä»¶ï¼Œæˆ–ç›´æ¥`DROP TABLE playlists CASCADE;`
2.  **æ‰‹åŠ¨è¿ç§»**ï¼šå…ˆå°†åˆ—è®¾ä¸ºnullableï¼Œæ’å…¥æ•°æ®åå†æ”¹ä¸ºnot nullã€‚

---

## ç¬¬äºŒæ­¥ï¼šä¿®æ”¹Serviceå±‚ï¼Œä¼ é€’Ownerä¿¡æ¯

ä¿®æ”¹`PlaylistService`ï¼Œåœ¨åˆ›å»ºæ­Œå•æ—¶éœ€è¦ä¼ å…¥æ‰€æœ‰è€…ã€‚

::: {.callout-tip}
## ğŸ¤– AI Prompt
"ä¿®æ”¹ `PlaylistService`ï¼š
1. `createPlaylist` æ–¹æ³•å¢åŠ  `ownerUsername` å‚æ•°ï¼Œæ ¹æ®ç”¨æˆ·åæŸ¥æ‰¾ User å¹¶å…³è”ã€‚
2. `deletePlaylist` å’Œ `addSongToPlaylist` æ–¹æ³•å¢åŠ  `currentUsername` å‚æ•°ã€‚
3. åœ¨æ‰§è¡Œåˆ é™¤æˆ–æ·»åŠ æ­Œæ›²å‰ï¼Œæ£€æŸ¥ `playlist.getOwner().getUsername()` æ˜¯å¦ç­‰äº `currentUsername`ã€‚å¦‚æœä¸ç­‰ï¼ŒæŠ›å‡º 403 Forbidden å¼‚å¸¸ã€‚"
:::

---

## ç¬¬ä¸‰æ­¥ï¼šåœ¨Controllerä¸­è·å–å½“å‰ç”¨æˆ·

æˆ‘ä»¬éœ€è¦ä»JWT Tokenä¸­æå–å½“å‰ç”¨æˆ·ä¿¡æ¯ã€‚Spring Securityæä¾›äº†ä¾¿æ·çš„æ–¹å¼ï¼šé€šè¿‡`Authentication`å¯¹è±¡ã€‚

::: {.callout-tip}
## ğŸ¤– AI Prompt
"ä¿®æ”¹ `PlaylistController`ï¼š
1. åœ¨æ–¹æ³•å‚æ•°ä¸­æ·»åŠ  `Authentication authentication`ã€‚
2. ä½¿ç”¨ `authentication.getName()` è·å–å½“å‰ç™»å½•çš„ç”¨æˆ·åã€‚
3. å°†ç”¨æˆ·åä¼ é€’ç»™ Service å±‚çš„æ–¹æ³•ã€‚"
:::

---

## ç¬¬å››æ­¥ï¼ˆè¿›é˜¶ï¼‰ï¼šä½¿ç”¨@PreAuthorizeæ³¨è§£

è™½ç„¶ä¸Šé¢çš„å®ç°å·²ç»å·¥ä½œï¼Œä½†æˆæƒé€»è¾‘å’Œä¸šåŠ¡é€»è¾‘æ··åœ¨ä¸€èµ·ã€‚æ›´ä¼˜é›…çš„æ–¹å¼æ˜¯ä½¿ç”¨Spring Securityçš„Method Securityã€‚

### å¯ç”¨Method Security

ä¿®æ”¹`SecurityConfig`ï¼Œæ·»åŠ `@EnableMethodSecurity`æ³¨è§£ã€‚

::: {.callout-tip}
## ğŸ¤– AI Prompt
"ä¿®æ”¹ `SecurityConfig`ï¼Œæ·»åŠ  `@EnableMethodSecurity` æ³¨è§£ï¼Œå¯ç”¨æ–¹æ³•çº§å®‰å…¨æ§åˆ¶ã€‚"
:::

### åˆ›å»ºæˆæƒæ£€æŸ¥å·¥å…·ç±»

::: {.callout-tip}
## ğŸ¤– AI Prompt
"åˆ›å»ºä¸€ä¸ª `SecurityUtils` Beanã€‚
å®ç° `isPlaylistOwner(playlistId, username)` æ–¹æ³•ï¼š
æŸ¥è¯¢æ•°æ®åº“ï¼Œæ£€æŸ¥æŒ‡å®šæ­Œå•çš„ owner æ˜¯å¦ä¸ username åŒ¹é…ã€‚"
:::

### ä½¿ç”¨@PreAuthorizeæ³¨è§£

ç°åœ¨å¯ä»¥åœ¨Controlleræ–¹æ³•ä¸Šä½¿ç”¨æ³¨è§£ï¼š

::: {.callout-tip}
## ğŸ¤– AI Prompt
"åœ¨ `PlaylistController` çš„ `deletePlaylist` æ–¹æ³•ä¸Šæ·»åŠ æ³¨è§£ï¼š
`@PreAuthorize("@securityUtils.isPlaylistOwner(#id, authentication.name)")`
è¿™æ ·åªæœ‰æ­Œå•ä¸»äººæ‰èƒ½è°ƒç”¨æ­¤æ¥å£ã€‚"
:::

**SpELè¡¨è¾¾å¼è§£æ**ï¼š
*   `@securityUtils`ï¼šå¼•ç”¨Springå®¹å™¨ä¸­çš„`securityUtils` Bean
*   `#id`ï¼šå¼•ç”¨æ–¹æ³•å‚æ•°`id`
*   `authentication.name`ï¼šå½“å‰è®¤è¯ç”¨æˆ·çš„ç”¨æˆ·å

**ä¼˜åŠ¿**ï¼š
*   æˆæƒé€»è¾‘ä¸ä¸šåŠ¡é€»è¾‘åˆ†ç¦»
*   å£°æ˜å¼ï¼Œæ˜“äºé˜…è¯»å’Œç»´æŠ¤
*   è‡ªåŠ¨è¿”å›403 Forbiddenï¼Œæ— éœ€æ‰‹åŠ¨æŠ›å¼‚å¸¸

---

## ç¬¬äº”æ­¥ï¼šéªŒè¯æˆæƒé€»è¾‘ï¼ˆVibe Checkï¼‰

### æµ‹è¯•ä¸€ï¼šåˆ›å»ºç”¨æˆ·Açš„æ­Œå•

```bash
# 1. ç”¨æˆ·Aç™»å½•
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "vibecoder", "password": "secret123"}'

# å¤åˆ¶è¿”å›çš„tokenï¼Œè®°ä¸ºTOKEN_A

# 2. åˆ›å»ºæ­Œå•
curl -X POST http://localhost:8080/api/playlists \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer TOKEN_A" \
  -d '{"name": "My Private Playlist"}'

# è¿”å›çš„å“åº”ä¸­åº”è¯¥æœ‰æ­Œå•IDï¼Œå‡è®¾æ˜¯1
```

### æµ‹è¯•äºŒï¼šç”¨æˆ·Bå°è¯•åˆ é™¤Açš„æ­Œå•ï¼ˆåº”è¯¥å¤±è´¥ï¼‰

```bash
# 1. æ³¨å†Œå¹¶ç™»å½•ç”¨æˆ·B
curl -X POST http://localhost:8080/api/auth/signup \
  -H "Content-Type: application/json" \
  -d '{"username": "eviluser", "password": "password123"}'

curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "eviluser", "password": "password123"}'

# å¤åˆ¶è¿”å›çš„tokenï¼Œè®°ä¸ºTOKEN_B

# 2. å°è¯•åˆ é™¤ç”¨æˆ·Açš„æ­Œå•
curl -X DELETE http://localhost:8080/api/playlists/1 \
  -H "Authorization: Bearer TOKEN_B"
```

**é¢„æœŸç»“æœ**ï¼š403 Forbiddenï¼Œè¿”å›"æ‚¨æ— æƒåˆ é™¤æ­¤æ­Œå•"

### æµ‹è¯•ä¸‰ï¼šç”¨æˆ·Aåˆ é™¤è‡ªå·±çš„æ­Œå•ï¼ˆåº”è¯¥æˆåŠŸï¼‰

```bash
curl -X DELETE http://localhost:8080/api/playlists/1 \
  -H "Authorization: Bearer TOKEN_A"
```

**é¢„æœŸç»“æœ**ï¼š204 No Contentï¼Œæ­Œå•è¢«æˆåŠŸåˆ é™¤

---

## Vibe Deep Diveï¼šæˆæƒæ¨¡å¼å¯¹æ¯”

### 1. RBACï¼ˆåŸºäºè§’è‰²ï¼‰

**ç¤ºä¾‹**ï¼š"ç®¡ç†å‘˜å¯ä»¥åˆ é™¤ä»»ä½•æ­Œå•ï¼Œæ™®é€šç”¨æˆ·åªèƒ½åˆ é™¤è‡ªå·±çš„"

```java
@PreAuthorize("hasRole('ADMIN') or @securityUtils.isPlaylistOwner(#id, authentication.name)")
```

**é€‚ç”¨åœºæ™¯**ï¼šä¼ä¸šåº”ç”¨ï¼Œæ˜ç¡®çš„è§’è‰²å±‚çº§ï¼ˆç®¡ç†å‘˜ã€ç¼–è¾‘ã€è®¿å®¢ï¼‰

### 2. ABACï¼ˆåŸºäºå±æ€§ï¼‰

**ç¤ºä¾‹**ï¼š"åªæœ‰VIPç”¨æˆ·æ‰èƒ½åˆ›å»ºè¶…è¿‡10ä¸ªæ­Œå•"

```java
@PreAuthorize("@userService.isVip(authentication.name) or @userService.getPlaylistCount(authentication.name) < 10")
```

**é€‚ç”¨åœºæ™¯**ï¼šå¤æ‚çš„ä¸šåŠ¡è§„åˆ™ï¼Œå¤šç»´åº¦å±æ€§ç»„åˆ

### 3. Resource-Basedï¼ˆåŸºäºèµ„æºæ‰€æœ‰æƒï¼‰

**ç¤ºä¾‹**ï¼šæˆ‘ä»¬å½“å‰çš„å®ç°

**é€‚ç”¨åœºæ™¯**ï¼šç¤¾äº¤åº”ç”¨ã€ä¸ªäººæ•°æ®ç®¡ç†

---

## Vibe Checkï¼ˆåŠ¨æ‰‹ä¸æ€è€ƒï¼‰

1.  **æ ¸å¿ƒç»ƒä¹ **ï¼š
    *   å®Œæˆä¸Šè¿°ä¸‰ä¸ªæµ‹è¯•ï¼Œç¡®ä¿æˆæƒé€»è¾‘æ­£å¸¸å·¥ä½œã€‚
    *   å°è¯•ç”¨Postmanæˆ–å…¶ä»–å·¥å…·æµ‹è¯•è¾¹ç•Œæƒ…å†µï¼ˆå¦‚ä½¿ç”¨å·²è¿‡æœŸçš„Tokenã€ä¸å­˜åœ¨çš„æ­Œå•IDï¼‰ã€‚

2.  **ç¼–ç ç»ƒä¹ **ï¼š
    *   ä¸º`addSongToPlaylist`æ–¹æ³•ä¹Ÿæ·»åŠ `@PreAuthorize`æ³¨è§£ï¼Œç¡®ä¿åªæœ‰ä¸»äººæ‰èƒ½æ·»åŠ æ­Œæ›²ã€‚
    *   å®ç°"åä½œæ­Œå•"åŠŸèƒ½ï¼šå…è®¸æ­Œå•ä¸»äººé‚€è¯·å…¶ä»–ç”¨æˆ·å…±åŒç¼–è¾‘ã€‚ï¼ˆæç¤ºï¼šéœ€è¦æ·»åŠ `playlist_collaborators`å…³è”è¡¨ï¼‰

3.  **å®‰å…¨æ€è€ƒ**ï¼š
    *   å¦‚æœæˆ‘ä»¬å¸Œæœ›å®ç°"æ­Œå•å¯ä»¥è®¾ä¸ºå…¬å¼€æˆ–ç§å¯†"ï¼Œåº”è¯¥å¦‚ä½•ä¿®æ”¹æˆæƒé€»è¾‘ï¼Ÿ
    *   å½“å‰å®ç°ä¸­ï¼Œå¦‚æœ`SecurityUtils.isPlaylistOwner`æ–¹æ³•æŸ¥è¯¢æ•°æ®åº“å¤±è´¥ï¼ˆå¦‚æ•°æ®åº“å®•æœºï¼‰ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

4.  **AIååŒ**ï¼š
    
    > "è¯·è§£é‡ŠSpring Securityä¸­`@PreAuthorize`å’Œ`@PostAuthorize`çš„åŒºåˆ«ã€‚ä»€ä¹ˆåœºæ™¯ä¸‹åº”è¯¥ä½¿ç”¨`@PostAuthorize`ï¼Ÿ"
    
    > "è¯·è§£é‡ŠRBACå’ŒABACä¸¤ç§æˆæƒæ¨¡å‹ã€‚åœ¨VibeVaultåº”ç”¨ä¸­ï¼Œå¦‚æœè¦å®ç°'åªæœ‰ä»˜è´¹ç”¨æˆ·æ‰èƒ½åˆ›å»ºè¶…è¿‡5ä¸ªæ­Œå•'ï¼Œåº”è¯¥ç”¨å“ªç§æ¨¡å‹ï¼Ÿå¦‚ä½•å®ç°ï¼Ÿ"

---

**å®Œç¾ï¼** ç°åœ¨ä½ çš„åº”ç”¨æ—¢çŸ¥é“"è°æ˜¯è°"ï¼ˆè®¤è¯ï¼‰ï¼Œä¹ŸçŸ¥é“"è°èƒ½åšä»€ä¹ˆ"ï¼ˆæˆæƒï¼‰ã€‚åœ¨ä¸‹ä¸€èŠ‚ï¼Œæˆ‘ä»¬å°†å®Œæˆå…¨æ ˆçš„æœ€åä¸€ç¯ï¼š**å°†ç¬¬9ç« çš„Reactå‰ç«¯æ¥å…¥è¿™ä¸ªå®‰å…¨ä½“ç³»**ï¼Œå®ç°çœŸæ­£çš„ç™»å½•ç•Œé¢å’ŒTokenç®¡ç†ï¼Œæ‰“é€šå…¨æ ˆä»»ç£äºŒè„‰ã€‚
